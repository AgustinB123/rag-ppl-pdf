/*
DROP TABLE [dbo].[CHATS];
DROP TABLE [dbo].[MENSAJES];
DROP TABLE [dbo].[MENSAJES_VISTOS];

ALTER TABLE [dbo].[CHATS] DROP CONSTRAINT [FK_MENSAJES_OPERACIONES]
ALTER TABLE [dbo].[MENSAJES] DROP CONSTRAINT [FK_MENSAJES_USUARIOS]
ALTER TABLE [dbo].[MENSAJES] DROP CONSTRAINT [FK_MENSAJES_CHATS]
ALTER TABLE [dbo].[MENSAJES_VISTOS] DROP CONSTRAINT [FK_MENSAJES_VISTOS_USUARIOS]
ALTER TABLE [dbo].[MENSAJES_VISTOS] DROP CONSTRAINT [FK_MENSAJES_VISTOS_MENSAJES]
*/

CREATE TABLE [dbo].[CHATS] (
    [IdChat]          INT         NOT NULL IDENTITY,
    [Tipo]            INT         NOT NULL,
    [NrOperacion]     CHAR (8),
    PRIMARY KEY CLUSTERED ([IdChat] ASC),
    CONSTRAINT [FK_MENSAJES_OPERACIONES] FOREIGN KEY ([NrOperacion]) REFERENCES [dbo].[OPERACIONES] ([NrOperacion]) ON DELETE CASCADE
);

CREATE TABLE [dbo].[MENSAJES] (
    [IdMensaje]    INT            NOT NULL IDENTITY,
    [IdChat]       INT            NOT NULL,
    [Fecha]        DATETIME       NOT NULL,
    [Comentario]   VARCHAR (MAX)  NOT NULL,
    [Usuario]      CHAR (10)      NOT NULL,
    PRIMARY KEY CLUSTERED ([IdMensaje] ASC),
    CONSTRAINT [FK_MENSAJES_USUARIOS] FOREIGN KEY ([Usuario]) REFERENCES [dbo].[USUARIOS] ([Codigo]),
	CONSTRAINT [FK_MENSAJES_CHATS] FOREIGN KEY ([IdChat]) REFERENCES [dbo].[CHATS] ([IdChat]) ON DELETE CASCADE
);

CREATE TABLE [dbo].[MENSAJES_VISTOS] (
    [IdMensaje]    INT       NOT NULL,
    [Usuario]      CHAR (10) NOT NULL,
    [Fecha]        DATETIME  NOT NULL,
    PRIMARY KEY CLUSTERED ([Usuario] ASC, [IdMensaje] ASC),
    CONSTRAINT [FK_MENSAJES_VISTOS_USUARIOS] FOREIGN KEY ([Usuario]) REFERENCES [dbo].[USUARIOS] ([Codigo]),
    CONSTRAINT [FK_MENSAJES_VISTOS_MENSAJES] FOREIGN KEY ([IdMensaje]) REFERENCES [dbo].[MENSAJES] ([IdMensaje]) ON DELETE CASCADE
);
